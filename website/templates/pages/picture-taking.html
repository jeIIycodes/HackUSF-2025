{% extends "layouts/base.html" %}

{% block title %} Skin Disease Check {% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content text-center">
    <h3 class="mb-4">ğŸ©º Skin Disease Check</h3>

    <!-- Video & Overlay Canvas -->
    <div class="position-relative d-inline-block">
      <video id="video" width="640" height="480" class="border rounded" autoplay></video>
      <canvas id="overlay" width="640" height="480" class="position-absolute top-0 start-0"></canvas>
    </div>

    <!-- Buttons -->
    <div class="mb-4 d-flex justify-content-center flex-wrap gap-2 mt-3">
      <button class="btn btn-outline-success" onclick="takePhoto()">ğŸ“¸ Take Photo</button>
      <button id="startBtn" class="btn btn-outline-primary" onclick="startRecording()">âº Start Recording</button>
      <button id="stopBtn" class="btn btn-outline-secondary" onclick="stopRecording()">â¹ Stop Recording</button>
      <button class="btn btn-outline-warning" onclick="clearAll()">ğŸ§¹ Clear All</button>
    </div>

    <!-- Detection Status -->
    <div id="detection-status" class="text-center fw-bold mb-4 text-secondary">
      ğŸ§  Waiting for detection...
    </div>
    
    <!-- Hidden Canvas -->
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <!-- Output Gallery -->
    <div id="output" class="row justify-content-center mt-4"></div>

    <!-- Back Button -->
    <div class="text-center mt-4">
      <a href="{{ url_for('home_blueprint.dashboard') }}" class="btn btn-lg btn-primary">
        ğŸ”™ Back to Dashboard
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const overlay = document.getElementById('overlay');
  const overlayCtx = overlay.getContext('2d');
  const output = document.getElementById('output');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const statusBox = document.getElementById('detection-status');
  let mediaRecorder;
  let chunks = [];

  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      video.srcObject = stream;
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const videoURL = URL.createObjectURL(blob);
        createMediaCard('video', videoURL);
        chunks = [];
      };
    });

  setInterval(() => { //
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataURL = canvas.toDataURL('image/png');

    fetch('/api/detect', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: dataURL })
    })
    .then(res => res.json())
    .then(data => drawBoxes(data.boxes));
  }, 1000);

  function drawBoxes(boxes) {
  overlayCtx.clearRect(0, 0, overlay.width, overlay.height);

  if (boxes.length === 0) {
    statusBox.innerText = 'âœ… No issues detected';
    statusBox.className = 'text-center fw-bold mb-4 text-success';
    return;
  }

  statusBox.innerText = 'âš ï¸ You Got Skin Cancer!!!!';
  statusBox.className = 'text-center fw-bold mb-4 text-danger';

  boxes.forEach(box => {
    overlayCtx.strokeStyle = 'red';
    overlayCtx.lineWidth = 3;
    overlayCtx.strokeRect(box.x, box.y, box.width, box.height);
    overlayCtx.font = '16px Arial';
    overlayCtx.fillStyle = 'red';
    overlayCtx.fillText(box.label, box.x, box.y - 5);
  });
}


  function takePhoto() {
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgSrc = canvas.toDataURL('image/png');
    createMediaCard('image', imgSrc);
  }

  function startRecording() {
    mediaRecorder.start();
    startBtn.innerText = 'ğŸ”´ Recording...';
    startBtn.classList.remove('btn-outline-primary');
    startBtn.classList.add('btn-danger');
    startBtn.disabled = true;
    stopBtn.disabled = false;
  }

  function stopRecording() {
    mediaRecorder.stop();
    startBtn.innerText = 'âº Start Recording';
    startBtn.classList.remove('btn-danger');
    startBtn.classList.add('btn-outline-primary');
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  function clearAll() {
    if (confirm("Are you sure you want to delete all captured media?")) {
      output.innerHTML = '';
    }
  }

  function createMediaCard(type, src) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-4';

    const card = document.createElement('div');
    card.className = 'card shadow-sm border';

    const media = document.createElement(type === 'image' ? 'img' : 'video');
    media.className = 'card-img-top';
    media.src = src;
    if (type === 'video') media.controls = true;

    const cardBody = document.createElement('div');
    cardBody.className = 'card-body text-center';

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-outline-danger btn-sm';
    deleteBtn.innerText = 'âŒ Delete';
    deleteBtn.onclick = () => col.remove();

    cardBody.appendChild(deleteBtn);
    card.appendChild(media);
    card.appendChild(cardBody);
    col.appendChild(card);
    output.appendChild(col);
  }

  window.onload = () => {
    stopBtn.disabled = true;
  }
</script>
{% endblock %}
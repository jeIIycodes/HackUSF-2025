{% extends "layouts/base.html" %}

{% block title %} Skin Disease Check {% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content text-center">
    <h3 class="mb-4">ðŸ©º Skin Disease Real-Time Detection</h3>

    <!-- Video & Overlay Canvas -->
    <div class="position-relative d-inline-block">
      <video id="video" width="640" height="480" class="border rounded" autoplay></video>
      <canvas id="overlay" width="640" height="480" class="position-absolute top-0 start-0"></canvas>
    </div>

    <!-- Detection Status -->
    <div id="detection-status" class="text-center fw-bold mb-4 text-secondary mt-3">
      ðŸ§  Waiting for detection...
    </div>

    <!-- Hidden Canvas for Capture -->
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <!-- Back Button -->
    <div class="text-center mt-4">
      <a href="{{ url_for('home_blueprint.dashboard') }}" class="btn btn-lg btn-primary">
        ðŸ”™ Back to Dashboard
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const overlay = document.getElementById('overlay');
  const overlayCtx = overlay.getContext('2d');
  const statusBox = document.getElementById('detection-status');

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    });

  setInterval(() => {
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataURL = canvas.toDataURL('image/png');

    fetch('/api/detect', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: dataURL })
    })
    .then(res => res.json())
    .then(data => drawBoxes(data.boxes));
  }, 1000);

  function drawBoxes(boxes) {
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);

    if (!boxes || boxes.length === 0) {
      statusBox.innerText = 'âœ… No issues detected';
      statusBox.className = 'text-center fw-bold mb-4 text-success';
      return;
    }

    statusBox.innerText = 'âš ï¸ Possible Signs Detected';
    statusBox.className = 'text-center fw-bold mb-4 text-danger';

    boxes.forEach(box => {
      overlayCtx.strokeStyle = 'red';
      overlayCtx.lineWidth = 3;
      overlayCtx.strokeRect(box.x, box.y, box.width, box.height);
      overlayCtx.font = '16px Arial';
      overlayCtx.fillStyle = 'red';
      overlayCtx.fillText(box.label, box.x, box.y - 5);
    });
  }
</script>
{% endblock %}
